<!-- index.html - Updated script loading for integrated WindowManager -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>NebulaDesk</title>

    <!-- Material 3 Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet">

    <!-- Nerd Fonts for terminal icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        /* Import Nerd Font from CDN */
        @import url('https://www.nerdfonts.com/assets/css/webfont.css');

        /* Define our terminal font stack with Nerd Font support */
        .terminal-font {
            font-family: 'FiraCode Nerd Font Mono', 'Fira Code', 'JetBrains Mono', 'Cascadia Code', 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace !important;
            font-feature-settings: "liga" 1, "calt" 1;
        }

        /* Ensure Nerd Font icons render properly */
        .nerd-icon {
            font-family: 'FiraCode Nerd Font', 'Symbols Nerd Font', monospace;
            font-weight: normal;
            font-style: normal;
            text-rendering: optimizeLegibility;
        }
    </style>

    <!-- Shoelace (explicit component imports - autoloader avoided) -->
    <link rel="stylesheet" data-shoelace-theme="true" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/dark.css">
    <!-- Individual Shoelace components (listed explicitly so autoloader is not required) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/button/button.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/input/input.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/textarea/textarea.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/select/select.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/checkbox/checkbox.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/radio/radio.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/icon/icon.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/icon-button/icon-button.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/dropdown/dropdown.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/components/dialog/dialog.js"></script>

    <!-- Inject a small CSS bridge to map Nebula theme variables into Shoelace custom properties -->
    <script>
        // Run after the main styles load so computed values are available
        function injectShoelaceBridge() {
            try {
                const rootStyles = getComputedStyle(document.documentElement);
                const map = {
                    '--sl-color-primary-600': rootStyles.getPropertyValue('--nebula-primary') || '#0b84ff',
                    '--sl-color-primary-500': rootStyles.getPropertyValue('--nebula-accent') || '#0ea5ff',
                    '--sl-color-neutral-0': rootStyles.getPropertyValue('--nebula-surface') || '#ffffff',
                    '--sl-color-neutral-900': rootStyles.getPropertyValue('--nebula-text-primary') || '#111827',
                    '--sl-color-background': rootStyles.getPropertyValue('--nebula-bg-primary') || '#f5f7fb',
                    '--sl-border-color': rootStyles.getPropertyValue('--nebula-border') || '#e5e7eb'
                };

                const css = ':root { ' + Object.entries(map).map(([k, v]) => `${k}: ${v.trim()};`).join(' ') + ' }';

                let el = document.getElementById('shoelace-nebula-bridge');
                if (!el) {
                    el = document.createElement('style');
                    el.id = 'shoelace-nebula-bridge';
                    document.head.appendChild(el);
                }
                el.textContent = css;
            } catch (err) {
                console.warn('Shoelace bridge injection failed', err);
            }
        }

        // Ensure it runs after a small delay so Nebula CSS variables are available
        window.addEventListener('load', () => setTimeout(injectShoelaceBridge, 60));
    </script>

        <!-- Small component overrides so Shoelace controls use Nebula sizing/shape -->
        <style id="shoelace-nebula-overrides">
            sl-button::part(base) {
                border-radius: var(--nebula-radius-sm, 6px);
                padding: 6px 12px;
                font-family: var(--nebula-font-family, system-ui, sans-serif);
                box-shadow: none;
                border: 1px solid var(--sl-border-color, rgba(0,0,0,0.08));
                background: var(--sl-color-primary-600, var(--nebula-primary));
                color: var(--sl-color-neutral-0, #fff);
            }

            sl-input::part(base),
            sl-textarea::part(base) {
                font-family: var(--nebula-font-family, system-ui, sans-serif);
            }
        </style>

    <!-- Our CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/nebula-theme.css">
    <link rel="stylesheet" href="css/nebula-extended-themes.css">
    <link rel="stylesheet" href="css/window-manager.css">
    <link rel="stylesheet" href="css/vertical-browser.css">
    <link rel="stylesheet" href="css/assistant.css">
    <link rel="stylesheet" href="css/NebulaApp-PWA.css">
    <link rel="stylesheet" href="css/window-titlebar-mode-styles.css">
    <link rel="stylesheet" href="css/nebula-material-icons.css">
    <link rel="stylesheet" href="css/capsule-preview.css">
    <link rel="stylesheet" href="css/nebula-theme-bridge.css">
    <link rel="stylesheet" href="css/shoelace-nebula-bridge.css">

    <!-- XTerm.js for terminal emulation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
</head>

<body>
    <!-- 
    LOAD ORDER IS IMPORTANT:
    1. WindowManager (with integrated app management)
    2. Apps that can be managed by WindowManager
    3. Standalone apps (assistant, etc.)
    4. XTerm.js dependencies
    5. Desktop Environment (renderer.js)
    -->

    <!-- Load Desktop Environment FIRST (creates #desktop element) -->
    <script src="js/renderer.js"></script>

    <!-- Load WindowManager SECOND -->
    <script src="js/WindowManager.js"></script>
    <script src="js/nebula-theme-manager.js"></script>

    <!-- Widget System - Load BEFORE apps and renderer -->
    <!-- <script src="js/NebulaWidgetSystem.js"></script>
    <script src="js/Widgets/NebulaLauncher.js"></script>
    <script src="js/Widgets/NebulaClock.js"></script> -->



    <!-- Load WM Apps First -->
    <script src="apps/browser.js"></script>
    <script src="apps/filemanager.js"></script>
    <script src="apps/NebulaTerminal.js"></script>
    <script src="apps/PickerApp.js"></script>
    <script src="ui/nebula-filepicker.js"></script>
    <script src="qbasic/QBTerminal.js"></script>
    <script src="apps/image-viewer.js"></script>
    <script src="apps/media-player.js"></script>

    <!-- Add these before renderer.js -->
    <!-- <script src="js/art-assistant.js"></script> -->
    <script src="js/code-assistant.js"></script>
    <script src="js/diff-merge-utility.js"></script>
    <script src="js/assistant.js"></script>

    <script src="js/NebulaSettings.js"></script>



    <!-- XTerm.js for image support -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <!-- Widget Integration - Load AFTER widgets but BEFORE renderer -->
    <script src="js/WidgetIntegration.js"></script>

    <!-- Load taskbar theme LAST -->
    <script src="js/taskbar-theme.js"></script>

    <!-- Theme change hook: refresh shoelace bridge and swap shoelace theme when Nebula theme changes -->
    <script>
    (function(){
        const darkHref = 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/dark.css';
        const lightHref = 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css';

        function refreshBridge() {
            const link = document.querySelector('link[href$="shoelace-nebula-bridge.css"]');
            if (!link) return;
            const parent = link.parentNode;
            const newLink = link.cloneNode(true);
            const base = link.getAttribute('href').split('?')[0];
            newLink.setAttribute('href', base + '?t=' + Date.now());
            parent.insertBefore(newLink, link.nextSibling);
            newLink.addEventListener('load', () => {
                // remove the old link after new one loads
                try { link.remove(); } catch (err) {}
            });
        }

        function setShoelaceThemeForNebula(themeId) {
            const link = document.querySelector('link[data-shoelace-theme]');
            if (!link) return;
            const prefersLight = (themeId && (themeId.includes('light') || themeId === 'nebula-minimal'));
            const desired = prefersLight ? lightHref : darkHref;
            if (link.getAttribute('href') !== desired) {
                link.setAttribute('href', desired + '?t=' + Date.now());
            }
        }

        window.addEventListener('themeChanged', (e) => {
            const themeId = e?.detail?.theme || null;
            // Refresh the bridge and swap Shoelace theme to better force re-render
            refreshBridge();
            setShoelaceThemeForNebula(themeId);
            // Force a small reflow to encourage components to pick up new vars
            document.documentElement.style.setProperty('--nebula-theme-refresh', Date.now());
            // Also force a quick repaint/reflow of Shoelace components
            setTimeout(() => {
                const els = document.querySelectorAll('sl-button, sl-input, sl-textarea, sl-select, sl-checkbox, sl-radio, sl-icon, sl-icon-button');
                els.forEach(el => {
                    try {
                        const prev = el.style.display || '';
                        el.style.display = 'none';
                        requestAnimationFrame(() => { el.style.display = prev; });
                    } catch (err) {
                        // ignore
                    }
                });
            }, 80);
        });
    })();
    </script>

</body>

</html>